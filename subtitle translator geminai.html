<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subtitle Translator | Motion Picture Mafia</title>
  <link rel="icon" type="image/png" href="Images/mpm logo.png">
  <meta name="description" content="Translate subtitles (.srt & .ass) into multiple languages. Upload, preview, translate and download.">

  <!-- JSZip + FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #f5f6fa;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 20px;
      background: #b91c1c;
      text-align: center;
    }
    header h1 { margin: 0; }
    main {
      flex: 1;
      padding: 20px;
      text-align: center;
    }
    input, select, button {
      margin: 10px;
      padding: 10px;
      border-radius: 6px;
      border: none;
    }
    button {
      background: #dc2626;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #b91c1c; }
    #dropZone {
      border: 2px dashed #dc2626;
      border-radius: 10px;
      padding: 30px;
      margin: 20px auto;
      max-width: 600px;
      background: #2a2a2a;
      cursor: pointer;
    }
    .file-list {
      max-width: 700px;
      margin: 20px auto;
      text-align: left;
      background: #2f2f2f;
      padding: 15px;
      border-radius: 10px;
    }
    .file-list li { margin: 8px 0; }
    pre.preview {
      background: #1f2937;
      padding: 10px;
      border-radius: 6px;
      max-height: 200px;
      overflow: auto;
      white-space: pre-wrap;
      font-size: 13px;
    }
    footer {
      background: #111;
      padding: 15px;
      text-align: center;
      color: #aaa;
      margin-top: auto;
    }
    .socials img {
      width: 28px;
      margin: 0 8px;
      vertical-align: middle;
      cursor: pointer;
    }
    .progress-container {
      width: 80%;
      margin: 20px auto;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 20px;
      width: 0%;
      background: #ef4444;
      text-align: center;
      color: white;
      font-size: 12px;
      transition: width 0.3s;
    }
  </style>
</head>
<body>

<header>
  <h1>üé¨ Subtitle Translator</h1>
  <p>Upload subtitles (.srt & .ass), translate, preview & download</p>
</header>

<main>
  <!-- Upload Section -->
  <div id="dropZone">üìÇ Drag & Drop subtitle files here or click to select</div>
  <input type="file" id="fileInput" multiple accept=".srt,.ass" style="display:none;">

  <!-- Language -->
  <select id="targetLang">
    <option value="si">Sinhala (Default)</option>
    <option value="en">English</option>
    <option value="es">Spanish</option>
    <option value="fr">French</option>
    <option value="de">German</option>
    <option value="ja">Japanese</option>
    <option value="hi">Hindi</option>
  </select>
  <button onclick="processFiles()">Translate Files</button>
  <button onclick="clearFiles()">Clear Files</button>

  <!-- Progress -->
  <div class="progress-container">
    <div id="progressBar" class="progress-bar">0%</div>
  </div>

  <!-- File List + Preview -->
  <ul id="fileList" class="file-list"></ul>
  <button id="downloadAll" style="display:none;" onclick="downloadAll()">‚¨á Download All as ZIP</button>
</main>

<footer>
  <div>
    <a href="index.html">üè† Home</a> | 
    <a href="games.html">üéÆ Free Games</a> | 
    <a href="subtitles.html">üìù Subtitles</a>
  </div>
  <div class="socials">
    <!-- Replace with your real links -->
    <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="Facebook"></a>
    <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/3670/3670051.png" alt="WhatsApp"></a>
    <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/3670/3670157.png" alt="Discord"></a>
  </div>
  <p>¬© 2025 Motion Picture Mafia Studio</p>
</footer>

<script>
const API_KEY = "AIzaSyA2XuZ79TAuQE4RP5o5BHun7Yvgc9BOg_w";
let translatedFiles = [];

// Gemini translation
async function translateTextGemini(text, targetLang = "si") {
  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: `Translate this into ${targetLang}:\n${text}` }] }]
      })
    }
  );

  const data = await response.json();
  if (data.candidates?.length > 0) {
    return data.candidates[0].content.parts[0].text.trim();
  }
  console.error("Gemini failed:", data);
  return text;
}

// Process uploaded files
async function processFiles() {
  const files = window.selectedFiles || [];
  const targetLang = document.getElementById("targetLang").value;
  const fileList = document.getElementById("fileList");
  fileList.innerHTML = "";
  translatedFiles = [];

  if (files.length === 0) {
    alert("Please upload files first.");
    return;
  }

  document.querySelector(".progress-container").style.display = "block";
  const progressBar = document.getElementById("progressBar");
  let completed = 0;

  for (let file of files) {
    const text = await file.text();

    // Translate only dialogue lines
    const translated = await Promise.all(
      text.split("\n").map(async line => {
        if (
          line.match(/^\d+$/) ||
          line.match(/^\d{2}:\d{2}/) ||
          line.startsWith("[")
        ) {
          return line;
        }
        return line.trim() ? await translateTextGemini(line, targetLang) : line;
      })
    );

    const finalText = translated.join("\n");
    translatedFiles.push({ name: file.name.replace(/\.(srt|ass)$/i, `_translated.$1`), content: finalText });

    // File entry with preview + download
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([finalText], { type: "text/plain" }));
    a.download = file.name.replace(/\.(srt|ass)$/i, `_translated.$1`);
    a.textContent = `‚¨á ${a.download}`;
    const preview = document.createElement("pre");
    preview.className = "preview";
    preview.textContent = finalText.slice(0, 500) + (finalText.length > 500 ? "\n... (preview truncated)" : "");
    li.textContent = file.name + " ‚Üí ";
    li.appendChild(a);
    li.appendChild(preview);
    fileList.appendChild(li);

    completed++;
    let percent = Math.round((completed / files.length) * 100);
    progressBar.style.width = percent + "%";
    progressBar.textContent = percent + "%";
  }

  if (translatedFiles.length > 1) {
    document.getElementById("downloadAll").style.display = "block";
  }
}

// Download all as ZIP
function downloadAll() {
  let zip = new JSZip();
  translatedFiles.forEach(file => zip.file(file.name, file.content));
  zip.generateAsync({ type: "blob" }).then(content => saveAs(content, "translated_subtitles.zip"));
}

// Clear uploaded files
function clearFiles() {
  window.selectedFiles = [];
  document.getElementById("fileList").innerHTML = "";
  document.getElementById("downloadAll").style.display = "none";
  document.querySelector(".progress-container").style.display = "none";
}

// Drag & Drop
const dropZone = document.getElementById("dropZone");
dropZone.addEventListener("click", () => document.getElementById("fileInput").click());
dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.style.background = "#3f3f3f"; });
dropZone.addEventListener("dragleave", () => dropZone.style.background = "#2a2a2a");
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  window.selectedFiles = [...e.dataTransfer.files];
  dropZone.style.background = "#2a2a2a";
  alert(`${window.selectedFiles.length} file(s) added`);
});
document.getElementById("fileInput").addEventListener("change", e => {
  window.selectedFiles = [...e.target.files];
  alert(`${window.selectedFiles.length} file(s) added`);
});
</script>

</body>
</html>
